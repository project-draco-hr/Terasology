{
  Prefab prefab=entity.getParentPrefab();
  if (prefab == null) {
    for (    Component comp : entity.iterateComponents()) {
      if (!COMMON_BLOCK_COMPONENTS.contains(comp.getClass())) {
        entity.removeComponent(comp.getClass());
      }
    }
  }
 else {
    for (    Component comp : entity.iterateComponents()) {
      if (!COMMON_BLOCK_COMPONENTS.contains(comp.getClass()) && !prefab.hasComponent(comp.getClass())) {
        entity.removeComponent(comp.getClass());
      }
    }
    for (    Component comp : prefab.iterateComponents()) {
      Component currentComp=entity.getComponent(comp.getClass());
      if (currentComp == null) {
        entity.addComponent(entityManager.getComponentLibrary().getMetadata(comp.getClass()).clone(comp));
      }
 else {
        ComponentMetadata<?> metadata=entityManager.getComponentLibrary().getMetadata(comp.getClass());
        boolean changed=false;
        for (        FieldMetadata field : metadata.iterateFields()) {
          Object expected=field.getValue(comp);
          if (!Objects.equal(expected,field.getValue(currentComp))) {
            field.setValue(currentComp,expected);
            changed=true;
          }
        }
        if (changed) {
          entity.saveComponent(currentComp);
        }
      }
    }
  }
  entityManager.destroyEntityWithoutEvents(entity);
}
