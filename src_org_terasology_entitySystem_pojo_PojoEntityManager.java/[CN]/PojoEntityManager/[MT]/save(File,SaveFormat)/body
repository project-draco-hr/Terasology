{
  EntityData.World.Builder world=EntityData.World.newBuilder();
  world.setNextEntityId(nextEntityId);
  TIntIterator idIterator=store.entityIdIterator();
  while (idIterator.hasNext()) {
    int id=idIterator.next();
    EntityData.Entity.Builder entity=EntityData.Entity.newBuilder();
    entity.setId(id);
    for (    Component component : iterateComponents(id)) {
      try {
        EntityData.Component.Builder componentMessage=EntityData.Component.newBuilder();
        componentMessage.setType(component.getName());
        SerializationInfo serializationInfo=componentSerializationLookup.get(component.getClass());
        if (serializationInfo != null) {
          for (          FieldInfo field : serializationInfo.fields) {
            Object rawValue=field.getValue(component);
            if (rawValue == null)             continue;
            EntityData.Value value=field.getSerializationHandler().serialize(rawValue);
            if (value == null)             continue;
            componentMessage.addField(EntityData.NameValue.newBuilder().setName(field.getName()).setValue(value).build());
          }
        }
 else {
          logger.log(Level.SEVERE,"Unregistered component type: " + component.getClass());
        }
        entity.addComponent(componentMessage.build());
      }
 catch (      IllegalAccessException e) {
        logger.log(Level.SEVERE,"Exception during serializing component type: " + component.getClass(),e);
      }
    }
    world.addEntity(entity.build());
  }
  FileOutputStream out=new FileOutputStream(file);
  BufferedWriter bufferedWriter=new BufferedWriter(new OutputStreamWriter(out));
  try {
switch (format) {
case Binary:
      world.build().writeTo(out);
    out.flush();
  break;
case Text:
TextFormat.print(world.build(),bufferedWriter);
bufferedWriter.flush();
break;
case JSON:
EntityDataJSONFormat.write(bufferedWriter,world.build());
bufferedWriter.flush();
break;
}
}
  finally {
try {
out.close();
}
 catch (IOException e) {
logger.log(Level.SEVERE,"Failed to close file",e);
}
}
}
