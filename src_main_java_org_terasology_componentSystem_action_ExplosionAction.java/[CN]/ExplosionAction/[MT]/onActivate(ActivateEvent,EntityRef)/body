{
  ExplosionActionComponent explosionComp=entity.getComponent(ExplosionActionComponent.class);
  Vector3f origin=null;
switch (explosionComp.relativeTo) {
case Self:
    LocationComponent loc=entity.getComponent(LocationComponent.class);
  if (loc != null) {
    origin=loc.getWorldPosition();
  }
break;
case Instigator:
origin=event.getInstigatorLocation();
break;
default :
origin=event.getTargetLocation();
break;
}
if (origin == null) {
return;
}
Vector3i blockPos=new Vector3i();
for (int i=0; i < 256; i++) {
Vector3f direction=new Vector3f(random.randomFloat(),random.randomFloat(),random.randomFloat());
direction.normalize();
Vector3f impulse=new Vector3f(direction);
impulse.scale(150);
for (int j=0; j < 4; j++) {
Vector3f target=new Vector3f(origin);
target.x+=direction.x * j;
target.y+=direction.y * j;
target.z+=direction.z * j;
blockPos.set((int)target.x,(int)target.y,(int)target.z);
Block currentBlock=worldProvider.getBlock(blockPos);
if (currentBlock.getId() == 0) continue;
if (currentBlock.isDestructible()) {
worldProvider.setBlock(blockPos,BlockManager.getInstance().getAir(),currentBlock);
EntityRef blockEntity=blockEntityRegistry.getEntityAt(blockPos);
blockEntity.destroy();
if (random.randomInt(4) == 0) {
EntityRef block=droppedBlockFactory.newInstance(target,currentBlock.getBlockFamily(),5);
block.send(new ImpulseEvent(impulse));
}
}
}
}
}
