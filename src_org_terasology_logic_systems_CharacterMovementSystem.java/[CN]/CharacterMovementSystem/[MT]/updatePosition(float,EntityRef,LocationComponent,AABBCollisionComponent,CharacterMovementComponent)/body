{
  Vector3f desiredVelocity=new Vector3f(movementComp.drive);
  float maxSpeed=movementComp.isSwimming ? movementComp.maxWaterSpeed : movementComp.maxGroundSpeed;
  if (movementComp.isRunning) {
    maxSpeed*=movementComp.runFactor;
  }
  desiredVelocity.scale(maxSpeed);
  Vector3f velocityDiff=new Vector3f(desiredVelocity);
  velocityDiff.sub(movementComp.velocity);
  velocityDiff.y=0;
  float changeMag=velocityDiff.length();
  if (changeMag > movementComp.groundFriction * delta) {
    velocityDiff.scale(movementComp.groundFriction * delta / changeMag);
  }
  movementComp.velocity.x+=velocityDiff.x;
  movementComp.velocity.z+=velocityDiff.z;
  if (movementComp.isSwimming) {
    movementComp.velocity.y+=Math.signum(desiredVelocity.y - movementComp.velocity.y) * Math.min(UnderwaterInteria * delta,TeraMath.fastAbs(desiredVelocity.y - movementComp.velocity.y));
    movementComp.velocity.y=Math.max(-movementComp.maxWaterSpeed,(movementComp.velocity.y - UnderwaterGravity * delta));
  }
 else {
    movementComp.velocity.y=Math.max(-TerminalVelocity,(float)(movementComp.velocity.y - Gravity * delta));
  }
  Vector3f worldPos=LocationHelper.localToWorldPos(location);
  Vector3f oldPos=new Vector3f(worldPos);
  worldPos.y+=movementComp.velocity.y * delta;
  Vector3f extents=new Vector3f(collision.extents);
  extents.scale(LocationHelper.totalScale(location));
  if (verticalHitTest(worldPos,oldPos,extents)) {
    movementComp.velocity.y=0;
    if (movementComp.jump) {
      movementComp.jump=false;
      movementComp.isGrounded=false;
      movementComp.velocity.y+=movementComp.jumpSpeed;
    }
 else     if (!movementComp.isGrounded) {
      movementComp.isGrounded=true;
    }
  }
 else {
    movementComp.isGrounded=false;
  }
  oldPos.set(worldPos);
  worldPos.x+=movementComp.velocity.x * delta;
  worldPos.z+=movementComp.velocity.z * delta;
  if (horizontalHitTest(worldPos,oldPos,extents)) {
    entity.send(new HorizontalCollisionEvent());
  }
  movementComp.velocity.x=(worldPos.x - oldPos.x) / delta;
  movementComp.velocity.z=(worldPos.z - oldPos.z) / delta;
  Vector3f dist=new Vector3f(worldPos.x - oldPos.x,0,worldPos.z - oldPos.z);
  if (movementComp.isGrounded) {
    movementComp.footstepDelta+=dist.length();
    if (movementComp.footstepDelta > movementComp.distanceBetweenFootsteps) {
      movementComp.footstepDelta-=movementComp.distanceBetweenFootsteps;
      entity.send(new FootstepEvent());
    }
  }
  location.position.set(LocationHelper.worldToLocalPos(location,worldPos));
  if (movementComp.faceMovementDirection) {
    float yaw=(float)Math.atan2(movementComp.velocity.x,movementComp.velocity.z);
    AxisAngle4f axisAngle=new AxisAngle4f(0,1,0,yaw);
    location.rotation.set(axisAngle);
  }
}
