{
  if (!event.getItem().exists() || !networkSystem.getOwnerEntity(event.getItem()).equals(networkSystem.getOwnerEntity(character))) {
    return;
  }
  EntityRef selectedItemEntity=event.getItem();
  Vector3f impulse=event.getImpulse();
  Vector3f newPosition=event.getNewPosition();
  ItemComponent item=selectedItemEntity.getComponent(ItemComponent.class);
  if (networkSystem.getMode().isAuthority()) {
    EntityManager entityManager=CoreRegistry.get(EntityManager.class);
    BlockItemComponent blockItem=selectedItemEntity.getComponent(BlockItemComponent.class);
    if (blockItem == null) {
      DroppedItemFactory droppedItemFactory=new DroppedItemFactory(entityManager);
      EntityRef droppedItem=droppedItemFactory.newInstance(new Vector3f(newPosition),item.icon,200,selectedItemEntity);
      if (!droppedItem.equals(EntityRef.NULL)) {
        droppedItem.send(new ImpulseEvent(new Vector3f(impulse)));
      }
    }
 else {
      DroppedBlockFactory droppedBlockFactory=new DroppedBlockFactory(entityManager);
      EntityRef droppedBlock=droppedBlockFactory.newInstance(new Vector3f(newPosition),blockItem.blockFamily,20,blockItem.placedEntity);
      if (!droppedBlock.equals(EntityRef.NULL)) {
        droppedBlock.send(new ImpulseEvent(new Vector3f(impulse)));
        blockItem.placedEntity=EntityRef.NULL;
        selectedItemEntity.saveComponent(blockItem);
      }
 else {
        return;
      }
    }
  }
  InventoryManager inventoryManager=CoreRegistry.get(InventoryManager.class);
  int newStackSize=inventoryManager.getStackSize(selectedItemEntity) - 1;
  inventoryManager.setStackSize(selectedItemEntity,event.getInventoryEntity(),newStackSize);
}
