{
  correctCursor();
  if (event.isDown() && lastFont != null) {
    String fullText=text.get();
switch (event.getKey().getId()) {
case KeyId.LEFT:
{
        if (hasSelection() && !isSelectionModifierActive()) {
          cursorPosition=Math.min(cursorPosition,selectionStart);
          selectionStart=cursorPosition;
        }
 else         if (cursorPosition > 0) {
          cursorPosition--;
          if (!isSelectionModifierActive()) {
            selectionStart=cursorPosition;
          }
        }
        event.consume();
        break;
      }
case KeyId.RIGHT:
{
      if (hasSelection() && !isSelectionModifierActive()) {
        cursorPosition=Math.max(cursorPosition,selectionStart);
        selectionStart=cursorPosition;
      }
 else       if (cursorPosition < fullText.length()) {
        cursorPosition++;
        if (!isSelectionModifierActive()) {
          selectionStart=cursorPosition;
        }
      }
      event.consume();
      break;
    }
case KeyId.HOME:
{
    cursorPosition=0;
    offset=0;
    if (!isSelectionModifierActive()) {
      selectionStart=cursorPosition;
    }
    event.consume();
    break;
  }
case KeyId.END:
{
  cursorPosition=fullText.length();
  if (!isSelectionModifierActive()) {
    selectionStart=cursorPosition;
  }
  event.consume();
  break;
}
default :
{
if (Keyboard.isKeyDown(KeyId.LEFT_CTRL) || Keyboard.isKeyDown(KeyId.RIGHT_CTRL)) {
  if (event.getKey() == Keyboard.Key.C) {
    copySelection();
    event.consume();
    break;
  }
}
}
}
if (!readOnly) {
switch (event.getKey().getId()) {
case KeyId.BACKSPACE:
{
if (hasSelection()) {
  removeSelection();
}
 else if (cursorPosition > 0) {
  String before=fullText.substring(0,cursorPosition - 1);
  String after=fullText.substring(cursorPosition);
  setText(before + after);
  cursorPosition--;
  selectionStart=cursorPosition;
}
event.consume();
break;
}
case KeyId.DELETE:
{
if (hasSelection()) {
removeSelection();
}
 else if (cursorPosition < fullText.length()) {
String before=fullText.substring(0,cursorPosition);
String after=fullText.substring(cursorPosition + 1);
setText(before + after);
}
event.consume();
break;
}
case KeyId.ENTER:
{
for (ActivateEventListener listener : listeners) {
listener.onActivated(this);
}
event.consume();
break;
}
default :
{
if (Keyboard.isKeyDown(KeyId.LEFT_CTRL) || Keyboard.isKeyDown(KeyId.RIGHT_CTRL)) {
if (event.getKey() == Keyboard.Key.V) {
removeSelection();
paste();
event.consume();
break;
}
 else if (event.getKey() == Keyboard.Key.X) {
copySelection();
removeSelection();
event.consume();
break;
}
}
if (event.getKeyCharacter() != 0 && lastFont.hasCharacter(event.getKeyCharacter())) {
String before=fullText.substring(0,Math.min(cursorPosition,selectionStart));
String after=fullText.substring(Math.max(cursorPosition,selectionStart));
setText(before + event.getKeyCharacter() + after);
cursorPosition=Math.min(cursorPosition,selectionStart) + 1;
selectionStart=cursorPosition;
event.consume();
}
break;
}
}
}
}
correctCursor();
updateOffset();
}
