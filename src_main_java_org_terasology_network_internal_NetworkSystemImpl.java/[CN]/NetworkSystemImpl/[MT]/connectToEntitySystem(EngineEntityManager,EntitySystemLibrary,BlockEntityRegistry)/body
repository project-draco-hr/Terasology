{
  if (this.entityManager != null) {
    this.entityManager.unsubscribe(this);
  }
  this.entityManager=newEntityManager;
  this.entityManager.subscribe(this);
  this.blockManager=CoreRegistry.get(BlockManager.class);
  this.ownershipHelper=new OwnershipHelper(newEntityManager.getComponentLibrary());
  this.storageManager=CoreRegistry.get(StorageManager.class);
  CoreRegistry.get(ComponentSystemManager.class).register(new NetworkEntitySystem(this),"engine:networkEntitySystem");
  TypeHandlerLibraryBuilder builder=new TypeHandlerLibraryBuilder();
  for (  Map.Entry<Class<?>,TypeHandler<?>> entry : library.getTypeHandlerLibrary()) {
    builder.addRaw(entry.getKey(),entry.getValue());
  }
  builder.add(EntityRef.class,new NetEntityRefTypeHandler(this,blockEntityRegistry));
  this.entitySystemLibrary=new EntitySystemLibraryImpl(builder.build());
  EventLibrary eventLibrary=entitySystemLibrary.getEventLibrary();
  for (  ClassMetadata<? extends Event> eventMetadata : library.getEventLibrary()) {
    eventLibrary.register(eventMetadata.getType(),eventMetadata.getName(),eventMetadata.getNames());
  }
  ComponentLibrary componentLibrary=entitySystemLibrary.getComponentLibrary();
  for (  ClassMetadata<? extends Component> componentMetadata : library.getComponentLibrary()) {
    componentLibrary.register(componentMetadata.getType(),componentMetadata.getName(),componentMetadata.getNames());
  }
  eventSerializer=new EventSerializer(eventLibrary);
  entitySerializer=new NetworkEntitySerializer(newEntityManager,componentLibrary);
  entitySerializer.setComponentSerializeCheck(new NetComponentSerializeCheck());
  if (mode == NetworkMode.CLIENT) {
    applySerializationTables();
  }
  if (server != null) {
    server.connectToEntitySystem(newEntityManager,entitySerializer,eventSerializer,blockEntityRegistry);
  }
}
