{
  FloraFacet facet=new FloraFacet(region.getRegion(),region.getBorderForFacet(FloraFacet.class));
  SurfaceHeightFacet surface=region.getRegionFacet(SurfaceHeightFacet.class);
  int minY=facet.getWorldRegion().minY();
  int maxY=facet.getWorldRegion().maxY();
  for (int z=facet.getWorldRegion().minZ(); z <= facet.getWorldRegion().maxZ(); z++) {
    for (int x=facet.getWorldRegion().minX(); x <= facet.getWorldRegion().maxX(); x++) {
      int height=TeraMath.floorToInt(surface.getWorld(x,z)) + 1;
      if (height >= minY && height <= maxY) {
        Vector3i pos=new Vector3i(x,height,z);
        if (Predicates.and(filters).apply(pos)) {
          Biome biome=biomeFacet.getWorld(x,z);
          Map<FloraType,Float> plantProb=probsTable.row(biome);
          FloraType type=getType(x,z,plantProb);
          if (type != null) {
            facet.setWorld(x,height,z,type);
          }
        }
      }
    }
  }
  return facet;
}
