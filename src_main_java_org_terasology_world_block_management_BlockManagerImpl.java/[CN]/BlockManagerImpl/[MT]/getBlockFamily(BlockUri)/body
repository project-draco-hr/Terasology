{
  BlockFamily family=registeredFamilyByUri.get(uri);
  if (family == null && generateNewIds) {
    if (isFreeformFamily(uri.getRootFamilyUri())) {
      family=blockLoader.loadWithShape(uri);
    }
 else {
      family=getAvailableBlockFamily(uri);
    }
    if (family != null) {
      for (      Block block : family.getBlocks()) {
        block.setId(getNextId());
      }
      registerFamily(family);
    }
  }
  return family;
}
