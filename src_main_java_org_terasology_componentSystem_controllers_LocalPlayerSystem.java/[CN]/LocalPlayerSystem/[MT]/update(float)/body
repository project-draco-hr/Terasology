{
  if (!localPlayer.isValid())   return;
  EntityRef entity=localPlayer.getEntity();
  LocalPlayerComponent localPlayerComponent=entity.getComponent(LocalPlayerComponent.class);
  CharacterMovementComponent characterMovementComponent=entity.getComponent(CharacterMovementComponent.class);
  LocationComponent location=entity.getComponent(LocationComponent.class);
  if (localPlayerComponent.isDead) {
    return;
  }
  updateMovement(localPlayerComponent,characterMovementComponent,location);
  Quat4f lookRotation=new Quat4f();
  QuaternionUtil.setEuler(lookRotation,TeraMath.DEG_TO_RAD * localPlayerComponent.viewYaw,TeraMath.DEG_TO_RAD * localPlayerComponent.viewPitch,0);
  updateCamera(characterMovementComponent,location.getWorldPosition(),lookRotation);
  localPlayerComponent.handAnimation=Math.max(0,localPlayerComponent.handAnimation - 2.5f * delta);
  entity.saveComponent(characterMovementComponent);
  entity.saveComponent(localPlayerComponent);
  if (toolbarChanged && cameraTargetSystem.getTarget().getComponent(CraftingActionComponent.class) == null) {
    UIItemContainer toolbar=(UIItemContainer)CoreRegistry.get(GUIManager.class).getWindowById("hud").getElementById("toolbar");
    toolbar.setEntity(localPlayer.getEntity(),0,9);
    toolbarChanged=false;
  }
  UIDisplayContainer inventory=(UIDisplayContainer)CoreRegistry.get(GUIManager.class).getWindowById("hud").getElementById("hud:inventory");
  if (inventory.isVisible() && timer.getTimeInMs() - lastTimeShowInventory >= 1500) {
    inventory.setVisible(false);
  }
}
