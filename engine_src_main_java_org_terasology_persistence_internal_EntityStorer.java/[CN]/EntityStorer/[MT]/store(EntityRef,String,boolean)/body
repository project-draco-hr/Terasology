{
  if (entity.isActive()) {
    for (    EntityRef ownedEntity : helper.listOwnedEntities(entity)) {
      if (!ownedEntity.isAlwaysRelevant()) {
        if (!ownedEntity.isPersistent()) {
          if (deactivate) {
            ownedEntity.destroy();
          }
        }
 else {
          store(ownedEntity,deactivate);
        }
      }
    }
    EntityRefTypeHandler.setReferenceInterceptor(this);
    EntityData.Entity entityData=serializer.serialize(entity,true,FieldSerializeCheck.NullCheck.<Component>newInstance());
    EntityRefTypeHandler.setReferenceInterceptor(null);
    entityStoreBuilder.addEntity(entityData);
    if (!name.isEmpty()) {
      entityStoreBuilder.addEntityName(name);
      entityStoreBuilder.addEntityNamed(entityData.getId());
    }
    storedEntityIds.add(entityData.getId());
    externalReferences.remove(entityData.getId());
    if (deactivate) {
      entityManager.deactivateForStorage(entity);
    }
  }
}
