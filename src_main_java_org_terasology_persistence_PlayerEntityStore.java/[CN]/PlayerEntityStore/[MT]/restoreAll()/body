{
  if (loadedData == null) {
    throw new IllegalStateException("Entity store not ready to restore entities");
  }
  Map<String,EntityRef> namedEntities=Maps.newHashMap();
  Map<Class<? extends Component>,Integer> idMap=Maps.newHashMap();
  for (int i=0; i < loadedData.getComponentClassCount(); ++i) {
    ClassMetadata<? extends Component> metadata=entityManager.getComponentLibrary().getMetadata(loadedData.getComponentClass(i));
    if (metadata != null) {
      idMap.put(metadata.getType(),i);
    }
  }
  serializer.setComponentIdMapping(idMap);
  for (int i=0; i < loadedData.getEntityCount(); ++i) {
    EntityRef entity=serializer.deserialize(loadedData.getEntity(i));
    if (!loadedData.getEntityName(i).isEmpty()) {
      namedEntities.put(loadedData.getEntityName(i),entity);
    }
  }
  loadedData=null;
  return namedEntities;
}
