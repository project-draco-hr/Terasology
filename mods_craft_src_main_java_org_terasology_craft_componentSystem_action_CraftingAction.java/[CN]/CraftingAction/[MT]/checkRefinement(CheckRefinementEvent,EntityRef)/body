{
  CraftingActionComponent craftingComponent=entity.getComponent(CraftingActionComponent.class);
  if (event.getInstigator().equals(EntityRef.NULL) || entity.equals(EntityRef.NULL)) {
    disablePossibleItem(craftingComponent);
    return;
  }
  LocalPlayerComponent localPlayer=event.getInstigator().getComponent(LocalPlayerComponent.class);
  InventoryComponent inventory=event.getInstigator().getComponent(InventoryComponent.class);
  if (localPlayer == null || inventory == null) {
    disablePossibleItem(craftingComponent);
    return;
  }
  if (craftingComponent.getAllElements().size() > 1) {
    return;
  }
 else {
    int countNotNulledElements=0;
    for (    EntityRef element : craftingComponent.getCurrentLevelElements()) {
      if (!element.equals(EntityRef.NULL)) {
        countNotNulledElements++;
      }
      if (countNotNulledElements > 1) {
        disablePossibleItem(craftingComponent);
        return;
      }
    }
  }
  UIItemContainer toolbar=(UIItemContainer)CoreRegistry.get(GUIManager.class).getWindowById("hud").getElementById("toolbar");
  ItemComponent instigatorItem=inventoryManager.getItemInSlot(event.getInstigator(),toolbar.getSlotStart() + localPlayer.selectedTool).getComponent(ItemComponent.class);
  int selectedCell=getSelectedItemFromCraftBlock(entity,craftingComponent.getCurrentLevel());
  EntityRef selectedEntity=craftingComponent.getCurrentLevelElements().get(selectedCell);
  ItemComponent targetItem=selectedEntity.getComponent(ItemComponent.class);
  if (instigatorItem == null || targetItem == null) {
    disablePossibleItem(craftingComponent);
    return;
  }
  String instigatorName=instigatorItem.name.toLowerCase();
  String targetName=targetItem.name.toLowerCase();
  if (entitesWithRefinement.containsKey(targetName) && entitesWithRefinement.get(targetName).containsKey(instigatorName)) {
    EntityRef refinementElement=createNewElement(entitesWithRefinement.get(targetName).get(instigatorName));
    if (!refinementElement.equals(EntityRef.NULL)) {
      craftingComponent.possibleItem=refinementElement;
      craftingComponent.isRefinement=true;
      entity.saveComponent(craftingComponent);
    }
  }
 else {
    if (craftingComponent.isRefinement) {
      if (!craftingComponent.possibleItem.equals(EntityRef.NULL)) {
        craftingComponent.possibleItem=EntityRef.NULL;
      }
      craftingComponent.isRefinement=false;
      entity.saveComponent(craftingComponent);
    }
  }
}
