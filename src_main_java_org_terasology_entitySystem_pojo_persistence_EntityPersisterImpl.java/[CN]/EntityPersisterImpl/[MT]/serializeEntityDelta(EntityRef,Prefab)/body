{
  EntityData.Entity.Builder entity=EntityData.Entity.newBuilder();
  entity.setId(entityRef.getId());
  entity.setParentPrefab(prefab.getName());
  for (  Component component : entityRef.iterateComponents()) {
    if (component.getClass().equals(EntityInfoComponent.class))     continue;
    Component prefabComponent=prefab.getComponent(component.getClass());
    EntityData.Component componentData;
    if (prefabComponent == null) {
      componentData=serializeComponent(component);
    }
 else {
      componentData=serializeComponent(prefabComponent,component);
    }
    if (componentData != null) {
      entity.addComponent(componentData);
    }
  }
  for (  Component prefabComponent : prefab.listComponents()) {
    if (!entityRef.hasComponent(prefabComponent.getClass())) {
      entity.addRemovedComponent(PersistenceUtil.getComponentClassName(prefabComponent.getClass()));
    }
  }
  return entity.build();
}
