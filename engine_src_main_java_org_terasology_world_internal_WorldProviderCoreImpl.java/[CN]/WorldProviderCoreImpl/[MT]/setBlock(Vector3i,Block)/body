{
  Vector3i chunkPos=TeraMath.calcChunkPos(worldPos);
  CoreChunk chunk=chunkProvider.getChunk(chunkPos);
  if (chunk != null) {
    Vector3i blockPos=TeraMath.calcBlockPos(worldPos);
    chunk.lock();
    Block oldBlockType=chunk.setBlock(blockPos,type);
    chunk.unlock();
    if (oldBlockType != type) {
      BlockChange oldChange=blockChanges.get(worldPos);
      if (oldChange == null) {
        blockChanges.put(worldPos,new BlockChange(worldPos,oldBlockType,type));
      }
 else {
        oldChange.setTo(type);
      }
      for (      Vector3i pos : TeraMath.getChunkRegionAroundWorldPos(worldPos,1)) {
        RenderableChunk dirtiedChunk=chunkProvider.getChunk(pos);
        if (dirtiedChunk != null) {
          dirtiedChunk.setDirty(true);
        }
      }
      notifyBlockChanged(worldPos,type,oldBlockType);
    }
    return oldBlockType;
  }
  return null;
}
