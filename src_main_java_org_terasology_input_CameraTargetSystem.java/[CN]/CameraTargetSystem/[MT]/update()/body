{
  if (!target.exists() && targetBlockPos != null) {
    target=blockRegistry.getOrCreateEntityAt(targetBlockPos);
  }
  boolean lostTarget=false;
  if (!target.exists()) {
    targetBlockPos=null;
    lostTarget=true;
  }
  Camera camera=CoreRegistry.get(WorldRenderer.class).getActiveCamera();
  BulletPhysics physicsRenderer=CoreRegistry.get(BulletPhysics.class);
  HitResult hitInfo=physicsRenderer.rayTrace(new Vector3f(camera.getPosition()),new Vector3f(camera.getViewingDirection()),TARGET_DISTANCE,filter);
  Vector3i newBlockPos=null;
  EntityRef newTarget=EntityRef.NULL;
  if (hitInfo.isHit()) {
    newTarget=hitInfo.getEntity();
    hitPosition=hitInfo.getHitPoint();
    hitNormal=hitInfo.getHitNormal();
    BlockComponent blockComp=newTarget.getComponent(BlockComponent.class);
    if (blockComp != null) {
      newBlockPos=new Vector3i(blockComp.getPosition());
    }
  }
  if (!Objects.equal(target,newTarget) || lostTarget) {
    EntityRef oldTarget=target;
    target=newTarget;
    targetBlockPos=newBlockPos;
    oldTarget.send(new CameraOutEvent());
    target.send(new CameraOverEvent());
    localPlayer.getEntity().send(new CameraTargetChangedEvent(oldTarget,target));
  }
}
