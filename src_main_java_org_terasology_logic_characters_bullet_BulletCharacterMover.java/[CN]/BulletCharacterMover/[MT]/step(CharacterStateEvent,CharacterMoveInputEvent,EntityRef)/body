{
  CharacterMovementComponent characterMovementComponent=entity.getComponent(CharacterMovementComponent.class);
  CharacterStateEvent result=new CharacterStateEvent(initial);
  result.setSequenceNumber(input.getSequenceNumber());
  if (worldProvider.isBlockRelevant(initial.getPosition())) {
    updatePosition(characterMovementComponent,result,input,entity);
    if (result.getMode() != MovementMode.GHOSTING) {
      checkSwimming(characterMovementComponent,result);
    }
  }
  result.setTime(initial.getTime() + input.getDeltaMs());
  updateRotation(characterMovementComponent,result,input);
  result.setPitch(input.getPitch());
  result.setYaw(input.getYaw());
  input.runComplete();
  return result;
}
