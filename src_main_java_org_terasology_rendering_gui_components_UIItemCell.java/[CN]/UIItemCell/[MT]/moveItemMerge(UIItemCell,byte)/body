{
  EntityRef item=getFromTransferSlot();
  ItemComponent sourceItem=item.getComponent(ItemComponent.class);
  ItemComponent targetItem=targetCell.ownerInventory.itemSlots.get(targetCell.slot).getComponent(ItemComponent.class);
  if (targetItem.stackId.equals(sourceItem.stackId) && !targetItem.stackId.isEmpty() && !sourceItem.stackId.isEmpty()) {
    if (amount == 0) {
      int spaceLeft=InventorySystem.MAX_STACK - targetItem.stackCount;
      if (spaceLeft < sourceItem.stackCount) {
        targetItem.stackCount=InventorySystem.MAX_STACK;
        sourceItem.stackCount-=spaceLeft;
        return true;
      }
 else {
        targetItem.stackCount+=sourceItem.stackCount;
        sendToTransferSlot(EntityRef.NULL,(byte)0);
        return true;
      }
    }
 else {
      int spaceLeft=InventorySystem.MAX_STACK - targetItem.stackCount;
      if (spaceLeft > amount) {
        targetItem.stackCount+=amount;
        if (sourceItem.stackCount > amount) {
          sourceItem.stackCount-=amount;
        }
 else {
          sendToTransferSlot(EntityRef.NULL,(byte)0);
        }
        return true;
      }
    }
  }
  return false;
}
