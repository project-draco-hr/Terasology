{
  Block air=BlockManager.getAir();
  int replaceCount=0;
  final Vector3i origin=Vector3i.zero();
  for (  Map.Entry<Vector3i,Block> newTreeBlock : nextTree.entrySet()) {
    Vector3i relativeLocation=newTreeBlock.getKey();
    Block oldBlock=currentTree.remove(relativeLocation);
    Block newBlock=newTreeBlock.getValue();
    Vector3i blockLocation=new Vector3i(treeLocation.x + relativeLocation.x,treeLocation.y + relativeLocation.y,treeLocation.z + relativeLocation.z);
    Block resultBlock=newBlock.getBlockFamily().getBlockForPlacement(worldProvider,blockEntityRegistry,blockLocation,null,null);
    if (oldBlock != null && oldBlock != newBlock) {
      if (relativeLocation.equals(origin)) {
        blockEntityRegistry.setBlockRetainComponent(blockLocation,resultBlock,LSystemTreeComponent.class,LivingTreeComponent.class);
      }
 else {
        worldProvider.setBlock(blockLocation,resultBlock);
      }
      replaceCount++;
    }
 else     if (oldBlock == null) {
      worldProvider.setBlock(blockLocation,resultBlock);
      replaceCount++;
    }
  }
  for (  Map.Entry<Vector3i,Block> oldTreeBlock : currentTree.entrySet()) {
    Vector3i location=oldTreeBlock.getKey();
    worldProvider.setBlock(new Vector3i(treeLocation.x + location.x,treeLocation.y + location.y,treeLocation.z + location.z),air);
    replaceCount++;
  }
  logger.debug("Replaced block count: " + replaceCount);
}
