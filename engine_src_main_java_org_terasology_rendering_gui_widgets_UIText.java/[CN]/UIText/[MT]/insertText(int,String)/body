{
  int prevWraps=getWrapOffset(cursorPosition);
  int currentWraps;
  int diff;
  boolean scrollbarVisibility=isScrollbarVisible();
  StringBuilder str=new StringBuilder(getText());
  String clampedString=string;
  if (maxLength > 0) {
    if (str.length() >= maxLength) {
      return 0;
    }
    if (str.length() + string.length() > maxLength) {
      clampedString=string.substring(0,maxLength - str.length());
    }
  }
  setText(str.insert(offset,clampedString).toString());
  calcContentHeight();
  if (scrollbarVisibility != isScrollbarVisible()) {
    setText(getText());
  }
  currentWraps=getWrapOffset(cursorPosition);
  diff=currentWraps - prevWraps;
  cursorPosition=cursorPosition - diff;
  return clampedString.length();
}
