{
  List<EntityRef> entitiesToStore=getEntitiesOfChunk(chunk);
  EntityStorer storer=new EntityStorer(entityManager);
  for (  EntityRef entityRef : entitiesToStore) {
    storer.store(entityRef,false);
  }
  EntityData.EntityStore entityStore=storer.finaliseStore();
  TIntSet externalRefs=storer.getExternalReferences();
  Vector3i chunkPosition=chunk.getPosition();
  ChunkImpl chunkImpl=(ChunkImpl)chunk;
  chunkImpl.createSnapshot();
  CompressedChunkBuilder compressedChunkBuilder=new CompressedChunkBuilder(entityStore,chunkImpl);
  saveTransactionBuilder.addCompressedChunkBuilder(chunkPosition,compressedChunkBuilder);
  if (externalRefs.size() > 0) {
    StoreMetadata metadata=new StoreMetadata(new ChunkStoreId(chunkPosition),externalRefs);
    indexStoreMetadata(metadata);
  }
}
