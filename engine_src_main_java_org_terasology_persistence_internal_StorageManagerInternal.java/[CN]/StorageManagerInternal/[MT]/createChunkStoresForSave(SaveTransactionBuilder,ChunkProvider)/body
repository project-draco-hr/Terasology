{
  unloadedAndSavingChunkMap.clear();
  Iterator<Map.Entry<Vector3i,CompressedChunkBuilder>> unsavedEntryIterator=unloadedAndUnsavedChunkMap.entrySet().iterator();
  while (unsavedEntryIterator.hasNext()) {
    Map.Entry<Vector3i,CompressedChunkBuilder> entry=unsavedEntryIterator.next();
    unloadedAndSavingChunkMap.put(entry.getKey(),entry.getValue());
    unsavedEntryIterator.remove();
  }
  for (  Chunk chunk : chunkProvider.getAllChunks()) {
    if (chunk.isReady()) {
      unloadedAndSavingChunkMap.remove(chunk.getPosition());
      saveTransactionBuilder.addCompressedChunkBuilder(chunk.getPosition(),createCompressedChunkBuilder(chunk,true));
    }
  }
  for (  Map.Entry<Vector3i,CompressedChunkBuilder> entry : unloadedAndSavingChunkMap.entrySet()) {
    saveTransactionBuilder.addCompressedChunkBuilder(entry.getKey(),entry.getValue());
  }
}
