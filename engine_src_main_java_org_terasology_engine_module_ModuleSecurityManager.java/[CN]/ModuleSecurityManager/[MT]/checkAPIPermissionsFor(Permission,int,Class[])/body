{
  Set<Class> allowed=Sets.union(allowedPermissionInstances.get(permission),allowedPermissionsTypes.get(permission.getClass()));
  for (int i=moduleDepth - 1; i >= 0; i--) {
    if (allowed.contains(stack[i])) {
      return;
    }
  }
  if (moduleDepth - 1 > 0) {
    throw new AccessControlException(String.format("Module class '%s' calling into '%s' requiring permission '%s'",stack[moduleDepth].getName(),stack[moduleDepth - 1].getName(),permission));
  }
 else {
    throw new AccessControlException(String.format("Module class '%s' requiring permission '%s'",stack[moduleDepth].getName(),permission));
  }
}
