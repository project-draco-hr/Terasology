{
  InventoryComponent inventory=inventoryEntity.getComponent(InventoryComponent.class);
  ItemComponent itemComponent=item.getComponent(ItemComponent.class);
  if (inventory != null && itemComponent != null) {
    boolean itemChanged=false;
    if (!itemComponent.stackId.isEmpty()) {
      for (      EntityRef entity : inventory.itemSlots) {
        ItemComponent otherItem=entity.getComponent(ItemComponent.class);
        if (otherItem != null && otherItem.stackId.equals(itemComponent.stackId) && otherItem.stackCount < MAX_STACK) {
          mergeItems(itemComponent,entity,otherItem);
          itemChanged=true;
        }
        if (itemComponent.stackCount == 0) {
          item.destroy();
          return true;
        }
      }
    }
    if (itemComponent.stackCount > 0) {
      int freeSlot=inventory.itemSlots.indexOf(EntityRef.NULL);
      if (freeSlot > -1) {
        putItemInSlot(item,itemComponent,freeSlot,inventoryEntity,inventory);
        return true;
      }
 else       if (itemChanged) {
        item.saveComponent(itemComponent);
      }
    }
  }
  return false;
}
