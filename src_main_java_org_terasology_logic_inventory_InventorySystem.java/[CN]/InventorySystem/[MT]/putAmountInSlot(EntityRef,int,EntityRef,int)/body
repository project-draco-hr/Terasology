{
  InventoryComponent inventory=inventoryEntity.getComponent(InventoryComponent.class);
  ItemComponent itemComponent=item.getComponent(ItemComponent.class);
  if (inventory != null && itemComponent != null) {
    ItemComponent targetItemComponent=inventory.itemSlots.get(slot).getComponent(ItemComponent.class);
    if (itemComponent.stackId.isEmpty() || amount >= itemComponent.stackCount) {
      putItemInSlot(inventoryEntity,slot,item);
      return true;
    }
 else     if (targetItemComponent == null) {
      EntityRef newItem=entityManager.copy(item);
      ItemComponent newItemComponent=newItem.getComponent(ItemComponent.class);
      newItemComponent.stackCount=(byte)amount;
      itemComponent.stackCount-=amount;
      putItemInSlot(newItem,newItemComponent,slot,inventoryEntity,inventory);
      item.saveComponent(itemComponent);
    }
 else     if (Objects.equal(targetItemComponent.stackId,itemComponent.stackId)) {
      int amountToTransfer=Math.min(amount,MAX_STACK - targetItemComponent.stackCount);
      if (amountToTransfer > 0) {
        targetItemComponent.stackCount+=amountToTransfer;
        itemComponent.stackCount-=amountToTransfer;
        inventory.itemSlots.get(slot).saveComponent(targetItemComponent);
        item.saveComponent(itemComponent);
      }
    }
  }
  return false;
}
