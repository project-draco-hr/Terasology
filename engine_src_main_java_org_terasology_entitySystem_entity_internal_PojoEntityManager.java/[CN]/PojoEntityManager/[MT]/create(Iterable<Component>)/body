{
  EntityRef entity=create();
  String prefabName=null;
  BlockUri blockUri=null;
  for (  Component component : components) {
    if (component instanceof EntityInfoComponent) {
      EntityInfoComponent comp=(EntityInfoComponent)component;
      prefabName=comp.parentPrefab;
      if (blockUri != null)       break;
    }
 else     if (component instanceof BlockComponent) {
      BlockComponent comp=(BlockComponent)component;
      blockUri=comp.getBlock().getBlockFamily().getURI();
      if (prefabName != null)       break;
    }
  }
  EntityBeingGenerated event=new EntityBeingGenerated(prefabName,blockUri,components);
  eventSystem.send(entity,event);
  components=event.getResultComponents();
  for (  Component c : components) {
    store.put(entity.getId(),c);
  }
  if (eventSystem != null) {
    eventSystem.send(entity,OnAddedComponent.newInstance());
    eventSystem.send(entity,OnActivatedComponent.newInstance());
  }
  return entity;
}
