{
  if (lastFont != null) {
    pos.x-=lastMargin.getLeft();
    pos.x+=offset;
    pos.y-=lastMargin.getTop();
    List<String> lines=TextLineBuilder.getLines(lastFont,getText(),Integer.MAX_VALUE);
    int lineIndex=TeraMath.clamp(pos.y / lastFont.getLineHeight(),0,lines.size() - 1);
    int newCursorPos=0;
    int totalWidth=0;
    for (    char c : lines.get(lineIndex).toCharArray()) {
      int charWidth=lastFont.getWidth(c);
      if (totalWidth + charWidth / 2 >= pos.x) {
        break;
      }
      newCursorPos++;
      totalWidth+=charWidth;
    }
    for (int i=0; i < lineIndex; ++i) {
      newCursorPos+=lines.get(i).length() + 1;
    }
    cursorPosition=newCursorPos;
    if (!isSelectionModifierActive() && !selecting) {
      selectionStart=cursorPosition;
    }
    updateOffset();
  }
}
