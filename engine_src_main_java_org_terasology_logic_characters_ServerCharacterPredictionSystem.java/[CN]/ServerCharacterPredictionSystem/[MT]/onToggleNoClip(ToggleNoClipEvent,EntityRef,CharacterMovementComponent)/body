{
  CircularBuffer<CharacterStateEvent> stateBuffer=characterStates.get(character);
  CharacterStateEvent lastState=stateBuffer.getLast();
  CharacterStateEvent newState=new CharacterStateEvent(lastState);
  newState.setSequenceNumber(lastState.getSequenceNumber());
  if (lastState.getMode() != MovementMode.GHOSTING) {
    newState.setMode(MovementMode.GHOSTING);
  }
 else {
    newState.setMode(MovementMode.WALKING);
  }
  stateBuffer.add(newState);
  CharacterStateEvent.setToState(character,newState);
}
