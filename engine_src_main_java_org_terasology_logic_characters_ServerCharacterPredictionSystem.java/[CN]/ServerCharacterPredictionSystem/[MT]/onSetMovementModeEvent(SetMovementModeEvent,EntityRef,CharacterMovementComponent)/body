{
  CircularBuffer<CharacterStateEvent> stateBuffer=characterStates.get(character);
  CharacterStateEvent lastState=stateBuffer.getLast();
  CharacterStateEvent newState=new CharacterStateEvent(lastState);
  newState.setSequenceNumber(lastState.getSequenceNumber());
  if (event.getMode() == MovementMode.GHOSTING) {
    if (lastState.getMode() != MovementMode.GHOSTING) {
      newState.setMode(MovementMode.GHOSTING);
    }
 else {
      newState.setMode(MovementMode.WALKING);
    }
  }
 else {
    newState.setMode(event.getMode());
  }
  stateBuffer.add(newState);
  CharacterStateEvent.setToState(character,newState);
}
