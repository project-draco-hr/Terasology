{
  CircularBuffer<CharacterState> stateBuffer=playerStates.get(entity);
  if (stateBuffer == null) {
    stateBuffer=CircularBuffer.create(BUFFER_SIZE);
    stateBuffer.add(createInitialState(entity));
    playerStates.put(entity,stateBuffer);
  }
  CharacterState lastState=stateBuffer.getLast();
  CharacterState newState=stepState(input,lastState,entity);
  stateBuffer.add(newState);
  setToState(entity,newState);
}
