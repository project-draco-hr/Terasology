{
  Vector3i blockPos=new Vector3i(x,y,z);
  ChunkView chunkView;
  if (oldType == type) {
    return true;
  }
  if (LightingUtil.compareLightingPropagation(type,oldType) != PropagationComparison.IDENTICAL || type.getLuminance() != oldType.getLuminance()) {
    chunkView=chunkProvider.getSubviewAroundBlock(blockPos,Chunk.MAX_LIGHT + 1);
  }
 else {
    chunkView=chunkProvider.getSubviewAroundBlock(blockPos,1);
  }
  if (chunkView != null) {
    chunkView.lock();
    try {
      Block current=chunkView.getBlock(x,y,z);
      if (current != oldType) {
        return false;
      }
      chunkView.setBlock(x,y,z,type);
      Region3i affected=new LightPropagator(chunkView).update(x,y,z,type,oldType);
      if (affected.isEmpty()) {
        chunkView.setDirtyAround(blockPos);
      }
 else {
        chunkView.setDirtyAround(affected);
      }
      notifyBlockChanged(x,y,z,type,oldType);
      return true;
    }
  finally {
      chunkView.unlock();
    }
  }
  return false;
}
