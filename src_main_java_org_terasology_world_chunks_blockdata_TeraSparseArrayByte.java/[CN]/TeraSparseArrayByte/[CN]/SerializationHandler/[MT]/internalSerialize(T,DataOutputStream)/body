{
  final byte[][] inflated=array.inflated;
  if (inflated == null) {
    out.writeBoolean(false);
    out.writeByte(array.fill);
  }
 else {
    final byte[] deflated=array.deflated;
    final int sizeY=array.getSizeY();
    final int rowlen=array.rowSize();
    out.writeBoolean(true);
    int rows=0;
    for (    final byte[] row : inflated) {
      if (row != null)       rows++;
    }
    out.writeInt(rows);
    for (int index=0; index < sizeY; index++) {
      final byte[] row=inflated[index];
      if (row == null) {
        continue;
      }
      Preconditions.checkState(row.length == rowlen,"Unexpected row length in sparse array of type " + array.getClass().getName() + ", should be "+ rowlen+ " but is "+ row.length);
      out.writeInt(index);
      for (      final byte b : row) {
        out.writeByte(b);
      }
    }
    for (int index=0; index < sizeY; index++) {
      if (inflated[index] == null)       out.writeByte(deflated[index]);
 else       out.writeByte(0);
    }
  }
}
