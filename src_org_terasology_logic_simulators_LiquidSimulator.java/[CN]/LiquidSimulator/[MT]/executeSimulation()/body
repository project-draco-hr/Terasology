{
  ArrayList<BlockPosition> currentActiveBlocks=tryCopyActiveBlocks();
  if (currentActiveBlocks != null) {
    boolean simulated=false;
    while (currentActiveBlocks.size() > 0) {
      simulated=true;
      int randomBlock=Math.abs(_parent.getRandom().randomInt()) % currentActiveBlocks.size();
      BlockPosition bp=currentActiveBlocks.get(randomBlock);
      BlockPosition bpd=new BlockPosition(bp.x,bp.y - 1,bp.z);
      try {
        _lock.lock();
        _activeBlocks.remove(bp);
      }
  finally {
        _lock.unlock();
      }
      currentActiveBlocks.remove(randomBlock);
      byte state=_parent.getState(bp.x,bp.y,bp.z);
      byte type=_parent.getBlock(bp.x,bp.y,bp.z);
      byte typeBelow=_parent.getBlock(bpd.x,bpd.y,bpd.z);
      if (state >= 1) {
        int minState=Integer.MAX_VALUE;
        for (int j=0; j < 4; j++) {
          byte nType=_parent.getBlock((int)NEIGHBORS4[j].x * j + bp.x,(int)NEIGHBORS4[j].y * j + bp.y,(int)NEIGHBORS4[j].z * j + bp.z);
          byte nState=_parent.getState((int)NEIGHBORS4[j].x * j + bp.x,(int)NEIGHBORS4[j].y * j + bp.y,(int)NEIGHBORS4[j].z * j + bp.z);
          if (nType == type) {
            if (nState < minState)             minState=nState;
          }
        }
        if (minState + 1 < state) {
          state--;
        }
 else         if (minState + 1 > state) {
          state++;
        }
      }
      _parent.setState(bp.x,bp.y,bp.z,state);
      if (state > 7) {
        _parent.setBlock(bp.x,bp.y,bp.z,(byte)0,false,true);
        _parent.setState(bp.x,bp.y,bp.z,(byte)0);
        continue;
      }
      if ((typeBelow == 0 || BlockManager.getInstance().getBlock(typeBelow).getBlockForm() == Block.BLOCK_FORM.BILLBOARD)) {
        _parent.setBlock(bpd.x,bpd.y,bpd.z,type,true,true);
        _parent.setState(bpd.x,bpd.y,bpd.z,(byte)1);
        addActiveBlock(bpd);
        continue;
      }
      if (typeBelow == BlockManager.getInstance().getBlock("Grass").getId() || typeBelow == BlockManager.getInstance().getBlock("Snow").getId()) {
        _parent.setBlock(bpd.x,bpd.y,bpd.z,BlockManager.getInstance().getBlock("Dirt").getId(),false,true);
      }
      for (int k=0; k < 4; k++) {
        BlockPosition nBp=new BlockPosition((int)NEIGHBORS4[k].x + bp.x,bp.y,(int)NEIGHBORS4[k].z + bp.z);
        byte nBpType=_parent.getBlock(nBp.x,nBp.y,nBp.z);
        if ((nBpType == 0 || BlockManager.getInstance().getBlock(nBpType).getBlockForm() == Block.BLOCK_FORM.BILLBOARD) && _parent.getBlock(nBp.x,nBp.y - 1,nBp.z) != type) {
          _parent.setBlock(nBp.x,nBp.y,nBp.z,type,true,true);
          _parent.setState(nBp.x,nBp.y,nBp.z,(byte)(state + 1));
          addActiveBlock(nBp);
        }
      }
    }
    return simulated;
  }
  return false;
}
