{
  float deltaSeconds=delta / 1000;
  for (  EntityRef entity : entityManager.iteratorEntities(HealthComponent.class)) {
    HealthComponent health=entity.getComponent(HealthComponent.class);
    if (health.currentHealth <= 0)     continue;
    if (health.currentHealth == health.maxHealth || health.regenRate == 0)     continue;
    health.timeSinceLastDamage+=deltaSeconds;
    if (health.timeSinceLastDamage >= health.waitBeforeRegen) {
      health.partialRegen+=deltaSeconds * health.regenRate;
      if (health.partialRegen >= 1) {
        health.currentHealth=Math.min(health.maxHealth,health.currentHealth + (int)health.partialRegen);
        health.partialRegen%=1f;
        if (health.currentHealth == health.maxHealth) {
          entity.send(new FullHealthEvent());
        }
      }
    }
    entity.saveComponent(health);
  }
}
