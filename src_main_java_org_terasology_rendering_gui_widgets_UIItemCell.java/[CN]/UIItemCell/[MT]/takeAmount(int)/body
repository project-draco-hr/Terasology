{
  SlotBasedInventoryManager inventoryManager=CoreRegistry.get(SlotBasedInventoryManager.class);
  EntityRef item=inventoryManager.getItemInSlot(ownerEntity,slot);
  ItemComponent itemComp=item.getComponent(ItemComponent.class);
  if (itemComp == null) {
    return;
  }
  ItemComponent transferItemComp=getTransferItem().getComponent(ItemComponent.class);
  if (transferItemComp == null) {
    if (itemComp.stackId.isEmpty() || amount >= itemComp.stackCount) {
      inventoryManager.removeItem(ownerEntity,item);
      setTransferItem(item);
    }
 else {
      EntityRef newItem=CoreRegistry.get(EntityManager.class).copy(item);
      ItemComponent newItemComponent=newItem.getComponent(ItemComponent.class);
      newItemComponent.stackCount=(byte)amount;
      newItem.saveComponent(newItemComponent);
      itemComp.stackCount-=amount;
      item.saveComponent(itemComp);
      setTransferItem(newItem);
    }
  }
 else   if (inventoryManager.canStackTogether(item,getTransferItem())) {
    int amountToTransfer=Math.min(amount,InventorySystem.MAX_STACK - transferItemComp.stackCount);
    if (amountToTransfer > 0) {
      transferItemComp.stackCount+=amountToTransfer;
      itemComp.stackCount-=amountToTransfer;
      getTransferItem().saveComponent(transferItemComp);
      if (itemComp.stackCount == 0) {
        item.destroy();
      }
 else {
        item.saveComponent(itemComp);
      }
    }
  }
}
