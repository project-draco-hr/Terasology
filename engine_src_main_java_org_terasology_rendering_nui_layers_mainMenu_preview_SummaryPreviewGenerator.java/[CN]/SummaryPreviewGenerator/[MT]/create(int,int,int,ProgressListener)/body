{
  int size=4 * width * height;
  final int offX=-width / 2;
  final int offY=-height / 2;
  ByteBuffer buf=ByteBuffer.allocateDirect(size);
  for (int y=0; y < height; ++y) {
    for (int x=0; x < width; ++x) {
      int px=(x + offX) * scale;
      int py=(y + offY) * scale;
      Rect2i area=Rect2i.createFromMinAndSize(px,py,scale,scale);
      Color c=worldGenerator.get(layerName,area);
      c.addToBuffer(buf);
    }
    if (Thread.currentThread().isInterrupted()) {
      throw new InterruptedException();
    }
    if (progressListener != null) {
      progressListener.onProgress((float)y / height);
    }
  }
  buf.flip();
  return buf;
}
